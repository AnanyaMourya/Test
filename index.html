<script>
    async function runAudit() {
        const res = await fetch('/audit_v2', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                meds: document.getElementById('meds').value,
                name_present: document.getElementById('c1').checked,
                doc_present: document.getElementById('c2').checked,
                diag_present: document.getElementById('c3').checked
            })
        });
        const data = await res.json();
        
        document.getElementById('result').style.display = 'block';
        
        // Main Results
        let html = `
            <h3>Audit Result</h3>
            <p><b>Drugs in this encounter:</b> ${data.count}</p>
            <p><b>EDL Compliance:</b> ${data.edl_pct}%</p>
            <p><b>Antibiotic Prescribed:</b> ${data.has_antibiotic}</p>
            
            <hr>
            <h4 style="color: #5c6bc0;">WHO Calculation Guide</h4>
            <p><small>Use these formulas to aggregate your data over multiple prescriptions:</small></p>
            <ul style="font-size: 0.85em; text-align: left;">
                <li><b>Avg Drugs:</b> ${data.formulas.avg_drugs_formula}</li>
                <li><b>Generic %:</b> ${data.formulas.generic_formula}</li>
                <li><b>Antibiotic %:</b> ${data.formulas.antibiotic_formula}</li>
                <li><b>EDL Compliance %:</b> ${data.formulas.edl_formula}</li>
            </ul>
        `;
        document.getElementById('details').innerHTML = html;
    }
</script>

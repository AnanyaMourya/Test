<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RxHelper | Patient-Centered Audit</title>
    <style>
        :root {
            --pastel-blue: #e3f2fd; --pastel-green: #e8f5e9; --soft-text: #455a64;
            --accent-blue: #90caf9; --accent-green: #a5d6a7;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #fcfdfd; color: var(--soft-text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .wizard-card { background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { color: #5c6bc0; text-align: center; font-weight: 300; }
        .step { display: none; animation: fadeIn 0.5s; }
        .step.active { display: block; }
        .check-item { background: var(--pastel-green); padding: 15px; margin: 10px 0; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; }
        textarea { width: 100%; height: 120px; border-radius: 10px; border: 1px solid var(--accent-blue); padding: 15px; font-size: 16px; outline: none; box-sizing: border-box; }
        .btn { background: #7986cb; color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; width: 100%; font-size: 18px; margin-top: 10px; transition: 0.3s; }
        .btn-back { background: #cfd8dc; color: #37474f; margin-top: 5px; }
        .btn:hover { opacity: 0.9; }
        .report-box { background: #fafafa; border-left: 8px solid var(--accent-green); padding: 20px; margin-top: 20px; border-radius: 0 15px 15px 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="wizard-card">
    <h1>RxHelper</h1>

    <div id="step1" class="step active">
        <p style="text-align: center;">Welcome. Let's start by looking at your prescription photo.</p>
        <div style="border: 2px dashed var(--accent-blue); padding: 30px; text-align: center; border-radius: 15px; background: var(--pastel-blue); cursor: pointer;" onclick="document.getElementById('fileInput').click()">
            <p>Click to upload Prescription Image</p>
            <input type="file" id="fileInput" hidden onchange="nextStep(2)">
        </div>
    </div>

    <div id="step2" class="step">
        <p>Is the following information clearly visible on the paper?</p>
        <div class="check-item"><span>Patient Name & Age</span><input type="checkbox" id="check_name" onchange="checkItem(0)"></div>
        <div class="check-item" id="item_doc" style="display:none"><span>Doctor's Name & Reg No.</span><input type="checkbox" id="check_doc" onchange="checkItem(1)"></div>
        <div class="check-item" id="item_diag" style="display:none"><span>Clinical Diagnosis</span><input type="checkbox" id="check_diag" onchange="checkItem(2)"></div>
        <button id="btn_step2" class="btn" style="display:none" onclick="nextStep(3)">Next: Medications</button>
        <button class="btn btn-back" onclick="nextStep(1)">Back</button>
    </div>

    <div id="step3" class="step">
        <p>Please type the names of the medicines prescribed (comma-separated).</p>
        <textarea id="meds_input" placeholder="Amoxicillin, Metformin, Paracetamol"></textarea>
        <button class="btn" onclick="generateReport()">Generate Audit Report</button>
        <button class="btn btn-back" onclick="nextStep(2)">Back</button>
    </div>

    <div id="step4" class="step">
        <h3>Your Audit Report</h3>
        <div id="report_content" class="report-box"></div>
        <button class="btn" onclick="location.reload()" style="background: var(--accent-green);">Start New Audit</button>
    </div>
</div>

<script>
    function nextStep(n) {
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
    }

    function checkItem(index) {
        if(index === 0) document.getElementById('item_doc').style.display = 'flex';
        if(index === 1) document.getElementById('item_diag').style.display = 'flex';
        if(index === 2) document.getElementById('btn_step2').style.display = 'block';
    }

    async function generateReport() {
        const meds = document.getElementById('meds_input').value;
        const res = await fetch('/audit_v2', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                meds: meds,
                name_present: document.getElementById('check_name').checked,
                doc_present: document.getElementById('check_doc').checked,
                diag_present: document.getElementById('check_diag').checked
            })
        });
        const data = await res.json();
        
        let reportHTML = `
            <p><b>Medicine Count:</b> ${data.count} (WHO Target: 1.6 - 1.8)</p>
            <p><b>EDL Compliance:</b> ${data.edl_pct}% (Target: 100%)</p>
            <p><b>Safety Status:</b> ${data.polypharmacy ? '<span style="color:red">Polypharmacy Alert</span>' : '<span style="color:green">Safe Count</span>'}</p>
            <hr>
            <h4>Analysis:</h4>
            <ul>${data.flags.map(f => `<li>${f}</li>`).join('')}</ul>
        `;
        document.getElementById('report_content').innerHTML = reportHTML;
        nextStep(4);
    }
</script>
</body>
</html>
